generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Models
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  config    Json     @default("{}")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  users         User[]
  organizations Organization[]
  auditLogs     AuditLog[]
  contracts     Contract[]
  quotes        Quote[]
  approvals     Approval[]
  approvalChains ApprovalChain[]
  approvalRequests ApprovalRequest[]
  notifications Notification[]
  masterProductAccess TenantProductAccess[]
  files         File[]
  carts         Cart[]
  orders        Order[]
  paymentMethods PaymentMethod[]
  deliveryMethods DeliveryMethod[]
  userAddresses UserAddress[]
  payments      Payment[]
  salaryDeductions SalaryDeduction[]
  salaryDeductionLimitRequests SalaryDeductionLimitRequest[]
  discountTiers DiscountTier[]
  userDiscountTiers UserDiscountTier[]
  promotions    Promotion[]
  coupons       Coupon[]
  promotionUsages PromotionUsage[]
  partners      Partner[]
  partnerTeamMembers PartnerTeamMember[]
  partnerCommissions PartnerCommission[]
  partnerResources PartnerResource[]
  connectorConfigs ConnectorConfig[]
  credentialVaults CredentialVault[]
  warehouses      Warehouse[]
  inventoryLevels InventoryLevel[]
  inventoryReservations InventoryReservation[]
  inventoryMovements InventoryMovement[]
  inventoryAlerts InventoryAlert[]
  inventorySyncJobs InventorySyncJob[]
  priceLists      PriceList[]
  customerPriceAssignments CustomerPriceAssignment[]
  priceOverrides  PriceOverride[]
  currencyExchangeRates CurrencyExchangeRate[]
  priceListSyncJobs PriceListSyncJob[]

  @@index([slug])
  @@index([isActive])
  @@map("tenants")
}

model User {
  id           String   @id @default(cuid())
  email        String
  passwordHash String
  firstName    String
  lastName     String
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  // Foreign Keys
  tenantId       String
  organizationId String?

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  auditLogs    AuditLog[]
  refreshTokens RefreshToken[]
  contractsCreated  Contract[]  @relation("ContractCreatedBy")
  contractsApproved Contract[]  @relation("ContractApprovedBy")
  quotesCreated     Quote[]     @relation("QuoteCreatedBy")
  quotesApproved    Quote[]     @relation("QuoteApprovedBy")
  approvalActions   Approval[]
  notifications     Notification[]
  filesUploaded     File[]
  carts             Cart[]
  orders            Order[]     @relation("OrderUser")
  ordersCancelled   Order[]     @relation("OrderCancelledBy")
  ordersRefunded    Order[]     @relation("OrderRefundedBy")
  addresses         UserAddress[]
  payments          Payment[]
  salaryDeduction   SalaryDeduction?
  salaryLimitRequests SalaryDeductionLimitRequest[] @relation("SalaryLimitRequestUser")
  salaryLimitReviews  SalaryDeductionLimitRequest[] @relation("SalaryLimitRequestReviewer")
  discountTier      UserDiscountTier?
  tiersAssigned     UserDiscountTier[] @relation("TierAssignedBy")
  couponsAssigned   Coupon[] @relation("CouponAssignedTo")
  promotionUsages   PromotionUsage[]
  partner           Partner?
  partnerTeamMemberships PartnerTeamMember[]
  inventoryReservations InventoryReservation[]
  inventoryMovements InventoryMovement[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?

  // Foreign Keys
  userId String

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  code        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Hierarchy
  parentId String?

  // Foreign Keys
  tenantId String

  // Relations
  tenant   Tenant        @relation(fields: [tenantId], references: [id])
  parent   Organization? @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children Organization[] @relation("OrganizationHierarchy")
  users    User[]
  contracts Contract[]
  partners Partner[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([parentId])
  @@map("organizations")
}

// ============================================
// Business Models
// ============================================

model Contract {
  id              String         @id @default(cuid())
  contractNumber  String
  title           String
  description     String?
  status          ContractStatus @default(DRAFT)
  version         Int            @default(1)
  effectiveDate   DateTime?
  expirationDate  DateTime?
  totalValue      Decimal?       @db.Decimal(15, 2)
  currency        String         @default("USD")
  terms           Json           @default("{}")
  metadata        Json           @default("{}")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?

  // Foreign Keys
  tenantId       String
  organizationId String?
  createdById    String
  approvedById   String?

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  createdBy    User          @relation("ContractCreatedBy", fields: [createdById], references: [id])
  approvedBy   User?         @relation("ContractApprovedBy", fields: [approvedById], references: [id])
  versions     ContractVersion[]
  quotes       Quote[]
  approvals    Approval[]

  @@unique([tenantId, contractNumber])
  @@index([tenantId])
  @@index([organizationId])
  @@index([status])
  @@index([createdById])
  @@map("contracts")
}

model ContractVersion {
  id         String   @id @default(cuid())
  version    Int
  changes    Json
  snapshot   Json
  createdAt  DateTime @default(now())

  // Foreign Keys
  contractId String

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, version])
  @@index([contractId])
  @@map("contract_versions")
}

model Quote {
  id           String      @id @default(cuid())
  quoteNumber  String
  title        String
  description  String?
  status       QuoteStatus @default(DRAFT)
  validUntil   DateTime?
  subtotal     Decimal     @db.Decimal(15, 2)
  discount     Decimal     @default(0) @db.Decimal(15, 2)
  tax          Decimal     @default(0) @db.Decimal(15, 2)
  total        Decimal     @db.Decimal(15, 2)
  currency     String      @default("USD")
  notes        String?
  metadata     Json        @default("{}")
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime?

  // Foreign Keys
  tenantId     String
  contractId   String?
  createdById  String
  approvedById String?

  // Relations
  tenant     Tenant     @relation(fields: [tenantId], references: [id])
  contract   Contract?  @relation(fields: [contractId], references: [id])
  createdBy  User       @relation("QuoteCreatedBy", fields: [createdById], references: [id])
  approvedBy User?      @relation("QuoteApprovedBy", fields: [approvedById], references: [id])
  lineItems  QuoteLineItem[]
  approvals  Approval[]

  @@unique([tenantId, quoteNumber])
  @@index([tenantId])
  @@index([contractId])
  @@index([status])
  @@index([createdById])
  @@map("quotes")
}

model QuoteLineItem {
  id          String  @id @default(cuid())
  lineNumber  Int
  productName String
  productSku  String?
  description String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(15, 2)
  discount    Decimal @default(0) @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)

  // Foreign Keys
  quoteId          String
  masterProductId  String?

  // Relations
  quote         Quote          @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  masterProduct MasterProduct? @relation(fields: [masterProductId], references: [id])

  @@unique([quoteId, lineNumber])
  @@index([quoteId])
  @@index([masterProductId])
  @@map("quote_line_items")
}

// ============================================
// Master Catalog Models
// ============================================

model Category {
  id              String     @id @default(cuid())
  name            String
  slug            String     @unique
  description     String?
  imageUrl        String?
  isActive        Boolean    @default(true)
  sortOrder       Int        @default(0)
  metadata        Json       @default("{}")
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Hierarchy
  parentId        String?

  // Relations
  parent          Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[] @relation("CategoryHierarchy")
  products        MasterProduct[]

  @@index([parentId])
  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model MasterProduct {
  id              String              @id @default(cuid())
  sku             String              @unique
  name            String
  description     String?
  category        String?
  subcategory     String?
  brand           String?
  manufacturer    String?
  uom             String              @default("EA")
  listPrice       Decimal             @db.Decimal(15, 2)
  currency        String              @default("USD")
  status          MasterProductStatus @default(ACTIVE)
  availability    ProductAvailability @default(IN_STOCK)
  primaryImage    String?
  images          Json                @default("[]")
  attributes      Json                @default("{}")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Foreign Keys
  categoryId      String?

  // Relations
  categoryEntity  Category?           @relation(fields: [categoryId], references: [id])
  tenantAccess    TenantProductAccess[]
  quoteLineItems  QuoteLineItem[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  inventoryLevels InventoryLevel[]
  priceListItems  PriceListItem[]

  @@index([sku])
  @@index([category])
  @@index([categoryId])
  @@index([status])
  @@index([availability])
  @@map("master_products")
}

model TenantProductAccess {
  id              String    @id @default(cuid())
  isActive        Boolean   @default(true)
  agreedPrice     Decimal?  @db.Decimal(15, 2)
  discountPercent Decimal?  @db.Decimal(5, 2)
  minQuantity     Int?
  maxQuantity     Int?
  validFrom       DateTime?
  validUntil      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Foreign Keys
  tenantId        String
  masterProductId String

  // Relations
  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  masterProduct MasterProduct @relation(fields: [masterProductId], references: [id])

  @@unique([tenantId, masterProductId])
  @@index([tenantId])
  @@index([masterProductId])
  @@map("tenant_product_access")
}

// ============================================
// Approval & Workflow Models
// ============================================

model ApprovalChain {
  id           String                @id @default(cuid())
  name         String
  description  String?
  entityType   ApprovalEntity
  isActive     Boolean               @default(true)
  isDefault    Boolean               @default(false)
  conditions   Json                  @default("{}")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  // Foreign Keys
  tenantId String

  // Relations
  tenant Tenant              @relation(fields: [tenantId], references: [id])
  levels ApprovalChainLevel[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([entityType])
  @@index([isActive])
  @@map("approval_chains")
}

model ApprovalChainLevel {
  id             String         @id @default(cuid())
  level          Int
  name           String
  approverType   ApproverType
  minApprovers   Int            @default(1)
  allowDelegation Boolean       @default(false)
  thresholdMin   Decimal?       @db.Decimal(15, 2)
  thresholdMax   Decimal?       @db.Decimal(15, 2)
  timeoutHours   Int?
  escalationLevel Int?

  // Foreign Keys
  chainId       String
  approverUserId String?
  approverRoleId String?

  // Relations
  chain ApprovalChain @relation(fields: [chainId], references: [id], onDelete: Cascade)

  @@unique([chainId, level])
  @@index([chainId])
  @@map("approval_chain_levels")
}

model ApprovalRequest {
  id           String               @id @default(cuid())
  entityType   ApprovalEntity
  entityId     String
  status       ApprovalRequestStatus @default(PENDING)
  currentLevel Int                  @default(1)
  metadata     Json                 @default("{}")
  requestedAt  DateTime             @default(now())
  completedAt  DateTime?
  expiresAt    DateTime?

  // Foreign Keys
  tenantId    String
  chainId     String
  requesterId String

  // Relations
  tenant    Tenant                   @relation(fields: [tenantId], references: [id])
  steps     ApprovalStep[]

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([chainId])
  @@index([status])
  @@map("approval_requests")
}

model ApprovalStep {
  id           String         @id @default(cuid())
  level        Int
  action       ApprovalAction
  status       ApprovalStatus @default(PENDING)
  comments     String?
  delegatedFrom String?
  requestedAt  DateTime       @default(now())
  respondedAt  DateTime?

  // Foreign Keys
  requestId  String
  approverId String

  // Relations
  request ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([approverId])
  @@index([status])
  @@map("approval_steps")
}

model Approval {
  id           String         @id @default(cuid())
  entityType   ApprovalEntity
  entityId     String
  action       ApprovalAction
  status       ApprovalStatus @default(PENDING)
  comments     String?
  metadata     Json           @default("{}")
  requestedAt  DateTime       @default(now())
  respondedAt  DateTime?

  // Foreign Keys
  tenantId    String
  requesterId String
  approverId  String

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  approver  User      @relation(fields: [approverId], references: [id])
  contract  Contract? @relation(fields: [entityId], references: [id], map: "approval_contract_fk")
  quote     Quote?    @relation(fields: [entityId], references: [id], map: "approval_quote_fk")

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([approverId])
  @@index([status])
  @@map("approvals")
}

// ============================================
// Platform Models
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String
  changes     Json     @default("{}")
  metadata    Json     @default("{}")
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Foreign Keys
  tenantId String
  userId   String

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  data      Json             @default("{}")
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Foreign Keys
  tenantId String
  userId   String

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model File {
  id           String     @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  bucket       String
  key          String
  entityType   String?
  entityId     String?
  metadata     Json       @default("{}")
  isPublic     Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  deletedAt    DateTime?

  // Foreign Keys
  tenantId    String
  uploadedById String

  // Relations
  tenant     Tenant @relation(fields: [tenantId], references: [id])
  uploadedBy User   @relation(fields: [uploadedById], references: [id])

  @@unique([bucket, key])
  @@index([tenantId])
  @@index([uploadedById])
  @@index([entityType, entityId])
  @@map("files")
}

// ============================================
// Enums
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
  VIEWER
}

enum ContractStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  EXPIRED
  TERMINATED
  CANCELLED
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum MasterProductStatus {
  ACTIVE
  DISCONTINUED
  ARCHIVED
}

enum ProductAvailability {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  PREORDER
  DISCONTINUED
}

enum ApprovalEntity {
  CONTRACT
  QUOTE
}

enum ApprovalAction {
  SUBMIT
  APPROVE
  REJECT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalRequestStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
}

enum ApproverType {
  USER
  ROLE
  MANAGER
  ORGANIZATION_HEAD
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
  APPROVAL_REQUIRED
  APPROVAL_COMPLETED
  CONTRACT_EXPIRING
  QUOTE_EXPIRING
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

// ============================================
// E-Commerce Models
// ============================================

model Order {
  id              String      @id @default(cuid())
  orderNumber     String
  status          OrderStatus @default(DRAFT)
  subtotal        Decimal     @db.Decimal(15, 2)
  discount        Decimal     @default(0) @db.Decimal(15, 2)
  couponCode      String?
  couponDiscount  Decimal     @default(0) @db.Decimal(15, 2)
  tax             Decimal     @default(0) @db.Decimal(15, 2)
  total           Decimal     @db.Decimal(15, 2)
  currency        String      @default("USD")
  notes           String?

  // Shipping Information
  shippingAddress Json        @default("{}")
  billingAddress  Json        @default("{}")

  // Tracking Information
  trackingNumber  String?
  trackingUrl     String?
  carrier         String?
  estimatedDelivery DateTime?

  // Timestamps
  confirmedAt     DateTime?
  processingAt    DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  refundedAt      DateTime?

  metadata        Json        @default("{}")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Foreign Keys
  tenantId        String
  userId          String
  cancelledById   String?
  refundedById    String?

  // Relations
  tenant          Tenant      @relation(fields: [tenantId], references: [id])
  user            User        @relation("OrderUser", fields: [userId], references: [id])
  cancelledBy     User?       @relation("OrderCancelledBy", fields: [cancelledById], references: [id])
  refundedBy      User?       @relation("OrderRefundedBy", fields: [refundedById], references: [id])
  items           OrderItem[]
  payments        Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id              String  @id @default(cuid())
  lineNumber      Int
  productName     String
  productSku      String?
  description     String?
  quantity        Int
  unitPrice       Decimal @db.Decimal(15, 2)
  discount        Decimal @default(0) @db.Decimal(15, 2)
  total           Decimal @db.Decimal(15, 2)
  metadata        Json    @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Foreign Keys
  orderId         String
  masterProductId String?

  // Relations
  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  masterProduct   MasterProduct? @relation(fields: [masterProductId], references: [id])

  @@unique([orderId, lineNumber])
  @@index([orderId])
  @@index([masterProductId])
  @@map("order_items")
}

model Cart {
  id           String     @id @default(cuid())
  subtotal     Decimal    @default(0) @db.Decimal(15, 2)
  discount     Decimal    @default(0) @db.Decimal(15, 2)
  tax          Decimal    @default(0) @db.Decimal(15, 2)
  total        Decimal    @default(0) @db.Decimal(15, 2)
  couponCode   String?
  couponDiscount Decimal  @default(0) @db.Decimal(15, 2)
  metadata     Json       @default("{}")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Foreign Keys
  tenantId String
  userId   String

  // Relations
  tenant Tenant     @relation(fields: [tenantId], references: [id])
  user   User       @relation(fields: [userId], references: [id])
  items  CartItem[]

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("carts")
}

model CartItem {
  id          String  @id @default(cuid())
  productName String
  productSku  String?
  quantity    Int
  unitPrice   Decimal @db.Decimal(15, 2)
  discount    Decimal @default(0) @db.Decimal(15, 2)
  total       Decimal @db.Decimal(15, 2)
  metadata    Json    @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  cartId          String
  masterProductId String?

  // Relations
  cart          Cart          @relation(fields: [cartId], references: [id], onDelete: Cascade)
  masterProduct MasterProduct? @relation(fields: [masterProductId], references: [id])

  @@unique([cartId, masterProductId])
  @@index([cartId])
  @@index([masterProductId])
  @@map("cart_items")
}

// ============================================
// Payment & Delivery Models
// ============================================

model PaymentMethod {
  id              String             @id @default(cuid())
  code            String
  name            String
  description     String?
  type            PaymentMethodType
  isActive        Boolean            @default(true)
  sortOrder       Int                @default(0)
  minAmount       Decimal?           @db.Decimal(15, 2)
  maxAmount       Decimal?           @db.Decimal(15, 2)
  processingFee   Decimal            @default(0) @db.Decimal(15, 2)
  processingFeePercent Decimal       @default(0) @db.Decimal(5, 2)
  config          Json               @default("{}")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant             @relation(fields: [tenantId], references: [id])
  payments        Payment[]
  userTypeAccess  PaymentMethodUserType[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@index([type])
  @@map("payment_methods")
}

model PaymentMethodUserType {
  id              String          @id @default(cuid())
  userRole        UserRole

  // Foreign Keys
  paymentMethodId String

  // Relations
  paymentMethod   PaymentMethod   @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)

  @@unique([paymentMethodId, userRole])
  @@index([paymentMethodId])
  @@map("payment_method_user_types")
}

model DeliveryMethod {
  id              String             @id @default(cuid())
  code            String
  name            String
  description     String?
  isActive        Boolean            @default(true)
  sortOrder       Int                @default(0)
  minDays         Int?
  maxDays         Int?
  baseCost        Decimal            @default(0) @db.Decimal(15, 2)
  freeThreshold   Decimal?           @db.Decimal(15, 2)
  config          Json               @default("{}")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant             @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@map("delivery_methods")
}

model UserAddress {
  id              String      @id @default(cuid())
  label           String?
  firstName       String
  lastName        String
  company         String?
  street1         String
  street2         String?
  city            String
  state           String?
  postalCode      String
  country         String      @default("US")
  phone           String?
  isDefault       Boolean     @default(false)
  isShipping      Boolean     @default(true)
  isBilling       Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?

  // Foreign Keys
  tenantId        String
  userId          String

  // Relations
  tenant          Tenant      @relation(fields: [tenantId], references: [id])
  user            User        @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([isDefault])
  @@map("user_addresses")
}

model Payment {
  id              String        @id @default(cuid())
  paymentNumber   String
  amount          Decimal       @db.Decimal(15, 2)
  currency        String        @default("USD")
  status          PaymentStatus @default(PENDING)
  externalRef     String?
  metadata        Json          @default("{}")
  processedAt     DateTime?
  failedAt        DateTime?
  failureReason   String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Foreign Keys
  tenantId        String
  orderId         String
  userId          String
  paymentMethodId String

  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  order           Order         @relation(fields: [orderId], references: [id])
  user            User          @relation(fields: [userId], references: [id])
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])

  @@unique([tenantId, paymentNumber])
  @@index([tenantId])
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("payments")
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  SALARY_DEDUCTION
  INVOICE
  WALLET
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ============================================
// Salary Deduction Models
// ============================================

model SalaryDeduction {
  id                String    @id @default(cuid())
  monthlyLimit      Decimal   @db.Decimal(15, 2)
  usedAmount        Decimal   @default(0) @db.Decimal(15, 2)
  remainingAmount   Decimal   @db.Decimal(15, 2)
  isEnabled         Boolean   @default(true)
  periodStart       DateTime
  periodEnd         DateTime
  autoRenewal       Boolean   @default(true)
  metadata          Json      @default("{}")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Foreign Keys
  tenantId          String
  userId            String    @unique

  // Relations
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  user              User      @relation(fields: [userId], references: [id])
  transactions      SalaryDeductionTransaction[]

  @@index([tenantId])
  @@index([userId])
  @@index([periodStart, periodEnd])
  @@map("salary_deductions")
}

model SalaryDeductionTransaction {
  id              String                     @id @default(cuid())
  amount          Decimal                    @db.Decimal(15, 2)
  type            SalaryDeductionTxnType
  status          SalaryDeductionTxnStatus   @default(PENDING)
  reference       String?
  description     String?
  processedAt     DateTime?
  metadata        Json                       @default("{}")
  createdAt       DateTime                   @default(now())
  updatedAt       DateTime                   @updatedAt

  // Foreign Keys
  salaryDeductionId String
  orderId           String?
  paymentId         String?

  // Relations
  salaryDeduction SalaryDeduction @relation(fields: [salaryDeductionId], references: [id])

  @@index([salaryDeductionId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@map("salary_deduction_transactions")
}

model SalaryDeductionLimitRequest {
  id              String                       @id @default(cuid())
  requestedLimit  Decimal                      @db.Decimal(15, 2)
  currentLimit    Decimal                      @db.Decimal(15, 2)
  reason          String?
  status          SalaryDeductionRequestStatus @default(PENDING)
  reviewedAt      DateTime?
  reviewNotes     String?
  metadata        Json                         @default("{}")
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt

  // Foreign Keys
  tenantId        String
  userId          String
  reviewedById    String?

  // Relations
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  user            User      @relation("SalaryLimitRequestUser", fields: [userId], references: [id])
  reviewedBy      User?     @relation("SalaryLimitRequestReviewer", fields: [reviewedById], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@map("salary_deduction_limit_requests")
}

enum SalaryDeductionTxnType {
  DEDUCTION
  REFUND
  ADJUSTMENT
}

enum SalaryDeductionTxnStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum SalaryDeductionRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================
// Discount Tiers Models
// ============================================

model DiscountTier {
  id              String            @id @default(cuid())
  name            String
  code            String
  description     String?
  level           Int               @default(0)
  discountPercent Decimal           @db.Decimal(5, 2)
  minSpend        Decimal?          @db.Decimal(15, 2)
  minOrders       Int?
  isActive        Boolean           @default(true)
  color           String?
  icon            String?
  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  userAssignments UserDiscountTier[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([level])
  @@index([isActive])
  @@map("discount_tiers")
}

model UserDiscountTier {
  id              String       @id @default(cuid())
  assignedAt      DateTime     @default(now())
  expiresAt       DateTime?
  reason          String?
  totalSpend      Decimal      @default(0) @db.Decimal(15, 2)
  totalOrders     Int          @default(0)
  totalSavings    Decimal      @default(0) @db.Decimal(15, 2)
  metadata        Json         @default("{}")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Foreign Keys
  tenantId        String
  userId          String       @unique
  discountTierId  String
  assignedById    String?

  // Relations
  tenant          Tenant       @relation(fields: [tenantId], references: [id])
  user            User         @relation(fields: [userId], references: [id])
  discountTier    DiscountTier @relation(fields: [discountTierId], references: [id])
  assignedBy      User?        @relation("TierAssignedBy", fields: [assignedById], references: [id])

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([discountTierId])
  @@map("user_discount_tiers")
}

// ============================================
// Promotions & Coupons Models
// ============================================

model Promotion {
  id              String          @id @default(cuid())
  name            String
  code            String
  description     String?
  type            PromotionType
  discountValue   Decimal         @db.Decimal(15, 2)
  discountType    DiscountType
  minOrderAmount  Decimal?        @db.Decimal(15, 2)
  maxDiscount     Decimal?        @db.Decimal(15, 2)
  usageLimit      Int?
  usageCount      Int             @default(0)
  perUserLimit    Int?
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean         @default(true)
  targetUserRoles UserRole[]
  conditions      Json            @default("{}")
  metadata        Json            @default("{}")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Foreign Keys
  tenantId        String
  createdById     String?

  // Relations
  tenant          Tenant          @relation(fields: [tenantId], references: [id])
  coupons         Coupon[]
  usages          PromotionUsage[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@index([type])
  @@map("promotions")
}

model Coupon {
  id              String        @id @default(cuid())
  code            String
  isActive        Boolean       @default(true)
  usageLimit      Int           @default(1)
  usageCount      Int           @default(0)
  expiresAt       DateTime?
  metadata        Json          @default("{}")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Foreign Keys
  tenantId        String
  promotionId     String
  assignedToId    String?

  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  promotion       Promotion     @relation(fields: [promotionId], references: [id])
  assignedTo      User?         @relation("CouponAssignedTo", fields: [assignedToId], references: [id])
  usages          PromotionUsage[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([promotionId])
  @@index([assignedToId])
  @@index([isActive])
  @@map("coupons")
}

model PromotionUsage {
  id              String        @id @default(cuid())
  discountApplied Decimal       @db.Decimal(15, 2)
  usedAt          DateTime      @default(now())
  metadata        Json          @default("{}")

  // Foreign Keys
  tenantId        String
  promotionId     String
  couponId        String?
  userId          String
  orderId         String?

  // Relations
  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  promotion       Promotion     @relation(fields: [promotionId], references: [id])
  coupon          Coupon?       @relation(fields: [couponId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([promotionId])
  @@index([couponId])
  @@index([userId])
  @@index([usedAt])
  @@map("promotion_usages")
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
  BOGO
  FREE_SHIPPING
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// ============================================
// Partner Models
// ============================================

model Partner {
  id                String           @id @default(cuid())
  code              String
  name              String
  description       String?
  commissionRate    Decimal          @default(0) @db.Decimal(5, 2)
  isActive          Boolean          @default(true)
  onboardedAt       DateTime         @default(now())
  metadata          Json             @default("{}")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Foreign Keys
  tenantId          String
  userId            String           @unique
  organizationId    String?

  // Relations
  tenant            Tenant           @relation(fields: [tenantId], references: [id])
  user              User             @relation(fields: [userId], references: [id])
  organization      Organization?    @relation(fields: [organizationId], references: [id])
  teamMembers       PartnerTeamMember[]
  commissions       PartnerCommission[]
  resources         PartnerResource[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([userId])
  @@index([organizationId])
  @@index([isActive])
  @@map("partners")
}

model PartnerTeamMember {
  id              String    @id @default(cuid())
  role            String?
  isActive        Boolean   @default(true)
  joinedAt        DateTime  @default(now())
  leftAt          DateTime?
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Foreign Keys
  tenantId        String
  partnerId       String
  userId          String

  // Relations
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  partner         Partner   @relation(fields: [partnerId], references: [id])
  user            User      @relation(fields: [userId], references: [id])

  @@unique([partnerId, userId])
  @@index([tenantId])
  @@index([partnerId])
  @@index([userId])
  @@index([isActive])
  @@map("partner_team_members")
}

model PartnerCommission {
  id              String                @id @default(cuid())
  amount          Decimal               @db.Decimal(15, 2)
  rate            Decimal               @db.Decimal(5, 2)
  orderTotal      Decimal               @db.Decimal(15, 2)
  status          PartnerCommissionStatus @default(PENDING)
  paidAt          DateTime?
  metadata        Json                  @default("{}")
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Foreign Keys
  tenantId        String
  partnerId       String
  orderId         String
  teamMemberId    String

  // Relations
  tenant          Tenant                @relation(fields: [tenantId], references: [id])
  partner         Partner               @relation(fields: [partnerId], references: [id])

  @@unique([partnerId, orderId])
  @@index([tenantId])
  @@index([partnerId])
  @@index([orderId])
  @@index([teamMemberId])
  @@index([status])
  @@index([createdAt])
  @@map("partner_commissions")
}

model PartnerResource {
  id              String    @id @default(cuid())
  title           String
  description     String?
  type            String
  url             String?
  fileKey         String?
  isPublic        Boolean   @default(false)
  sortOrder       Int       @default(0)
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Foreign Keys
  tenantId        String
  partnerId       String?
  uploadedById    String?

  // Relations
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  partner         Partner?  @relation(fields: [partnerId], references: [id])

  @@index([tenantId])
  @@index([partnerId])
  @@index([type])
  @@index([isPublic])
  @@map("partner_resources")
}

enum PartnerCommissionStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

// ============================================
// Integration Hub Models
// ============================================

model IntegrationMessage {
  id              String                    @id @default(cuid())
  messageId       String                    @unique
  correlationId   String?
  sourceConnector String
  targetConnector String
  direction       IntegrationDirection
  type            String
  status          IntegrationMessageStatus  @default(PENDING)
  priority        Int                       @default(0)

  // Payload
  sourcePayload   Json
  canonicalPayload Json?
  targetPayload   Json?

  // Transformation
  transformedAt   DateTime?
  transformErrors Json?

  // Retry handling
  retryCount      Int                       @default(0)
  maxRetries      Int                       @default(3)
  nextRetryAt     DateTime?
  lastError       String?
  errorDetails    Json?

  // Dead-letter queue
  dlqReason       String?
  movedToDlqAt    DateTime?

  // Circuit breaker
  circuitState    String?

  // Idempotency
  idempotencyKey  String?
  processedHash   String?
  isDuplicate     Boolean                   @default(false)

  // Timestamps
  receivedAt      DateTime                  @default(now())
  processedAt     DateTime?
  completedAt     DateTime?
  failedAt        DateTime?

  metadata        Json                      @default("{}")
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([messageId])
  @@index([correlationId])
  @@index([sourceConnector])
  @@index([targetConnector])
  @@index([status])
  @@index([type])
  @@index([idempotencyKey])
  @@index([nextRetryAt])
  @@index([movedToDlqAt])
  @@index([createdAt])
  @@map("integration_messages")
}

model IntegrationConnector {
  id              String                    @id @default(cuid())
  code            String                    @unique
  name            String
  description     String?
  type            IntegrationConnectorType
  direction       IntegrationDirection
  isActive        Boolean                   @default(true)

  // Plugin system
  pluginPath      String?
  pluginVersion   String?
  isBuiltIn       Boolean                   @default(false)

  // Configuration
  config          Json                      @default("{}")
  credentials     Json                      @default("{}")
  configSchema    Json?

  // Capability declaration
  declaredCapabilities String[]

  // Rate limiting
  rateLimit       Int?
  rateLimitWindow Int?
  currentCount    Int                       @default(0)
  windowStart     DateTime?

  // Circuit breaker
  circuitState    CircuitBreakerState       @default(CLOSED)
  failureCount    Int                       @default(0)
  failureThreshold Int                      @default(5)
  successCount    Int                       @default(0)
  successThreshold Int                      @default(3)
  lastFailureAt   DateTime?
  circuitOpenedAt DateTime?
  halfOpenAt      DateTime?

  // Health
  lastHealthCheck DateTime?
  healthStatus    ConnectorHealthStatus     @default(UNKNOWN)
  healthDetails   Json?

  // Statistics
  totalMessages   Int                       @default(0)
  successfulMessages Int                    @default(0)
  failedMessages  Int                       @default(0)

  metadata        Json                      @default("{}")
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  // Relations
  configs         ConnectorConfig[]
  capabilities    ConnectorCapability[]

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([circuitState])
  @@index([healthStatus])
  @@map("integration_connectors")
}

model IntegrationDeadLetter {
  id              String                    @id @default(cuid())
  originalMessageId String
  connector       String
  reason          String
  errorMessage    String?
  errorStack      String?
  payload         Json
  metadata        Json                      @default("{}")
  retryable       Boolean                   @default(true)
  reprocessedAt   DateTime?
  reprocessedById String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([originalMessageId])
  @@index([connector])
  @@index([reason])
  @@index([retryable])
  @@index([createdAt])
  @@map("integration_dead_letters")
}

model IntegrationTransformation {
  id              String                    @id @default(cuid())
  name            String
  description     String?
  sourceConnector String
  targetConnector String
  sourceType      String
  targetType      String
  isActive        Boolean                   @default(true)
  priority        Int                       @default(0)

  // Transformation rules
  sourceToCanonical Json
  canonicalToTarget Json

  // Validation
  sourceSchema    Json?
  canonicalSchema Json?
  targetSchema    Json?

  metadata        Json                      @default("{}")
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@unique([sourceConnector, targetConnector, sourceType, targetType])
  @@index([sourceConnector])
  @@index([targetConnector])
  @@index([isActive])
  @@map("integration_transformations")
}

enum IntegrationDirection {
  INBOUND
  OUTBOUND
  BIDIRECTIONAL
}

enum IntegrationMessageStatus {
  PENDING
  TRANSFORMING
  TRANSFORMED
  ROUTING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
  DEAD_LETTER
}

enum IntegrationConnectorType {
  ERP
  CRM
  ECOMMERCE
  PAYMENT
  SHIPPING
  INVENTORY
  WEBHOOK
  API
  FILE
  CUSTOM
}

enum CircuitBreakerState {
  CLOSED
  OPEN
  HALF_OPEN
}

enum ConnectorHealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

// ============================================
// Connector Registry Models
// ============================================

model ConnectorConfig {
  id              String                @id @default(cuid())
  name            String
  description     String?
  isActive        Boolean               @default(true)
  isPrimary       Boolean               @default(false)

  // Configuration
  config          Json                  @default("{}")

  // Encrypted credentials reference
  credentialVaultId String?

  // Rate limiting overrides
  rateLimit       Int?
  rateLimitWindow Int?

  // Tenant-specific transformation overrides
  transformationOverrides Json?

  // Capability overrides
  enabledCapabilities String[]

  // Webhook configuration
  webhookUrl      String?
  webhookSecret   String?
  webhookEvents   String[]

  // Connection validation
  lastTestedAt    DateTime?
  lastTestResult  ConnectorTestStatus?
  lastTestError   String?

  metadata        Json                  @default("{}")
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Foreign Keys
  tenantId        String
  connectorId     String

  // Relations
  tenant          Tenant                @relation(fields: [tenantId], references: [id])
  connector       IntegrationConnector  @relation(fields: [connectorId], references: [id])
  credentialVault CredentialVault?      @relation(fields: [credentialVaultId], references: [id])

  @@unique([tenantId, connectorId, name])
  @@index([tenantId])
  @@index([connectorId])
  @@index([isActive])
  @@map("connector_configs")
}

model CredentialVault {
  id              String                @id @default(cuid())
  name            String
  description     String?
  type            CredentialType

  // Encrypted credentials (AES-256-GCM)
  encryptedData   String
  encryptionKeyId String
  iv              String
  authTag         String

  // Access control
  accessPolicy    Json                  @default("{}")

  // Rotation
  expiresAt       DateTime?
  rotatedAt       DateTime?
  rotationPolicy  Json?

  // Audit
  lastAccessedAt  DateTime?
  accessCount     Int                   @default(0)

  metadata        Json                  @default("{}")
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant                @relation(fields: [tenantId], references: [id])
  connectorConfigs ConnectorConfig[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([type])
  @@index([expiresAt])
  @@map("credential_vaults")
}

model ConnectorCapability {
  id              String                @id @default(cuid())
  code            String
  name            String
  description     String?
  category        CapabilityCategory

  // Capability definition
  inputSchema     Json?
  outputSchema    Json?
  configSchema    Json?

  // Requirements
  requiredScopes  String[]
  requiredPermissions String[]

  // Flags
  isOptional      Boolean               @default(true)
  isDeprecated    Boolean               @default(false)
  deprecatedMessage String?

  metadata        Json                  @default("{}")
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  // Foreign Keys
  connectorId     String

  // Relations
  connector       IntegrationConnector  @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  @@unique([connectorId, code])
  @@index([connectorId])
  @@index([category])
  @@map("connector_capabilities")
}

model ConnectorEvent {
  id              String                @id @default(cuid())
  eventType       ConnectorEventType
  connectorCode   String
  configId        String?

  // Event data
  data            Json                  @default("{}")
  error           String?
  duration        Int?

  // Context
  tenantId        String?
  userId          String?
  correlationId   String?

  metadata        Json                  @default("{}")
  createdAt       DateTime              @default(now())

  @@index([connectorCode])
  @@index([eventType])
  @@index([tenantId])
  @@index([createdAt])
  @@map("connector_events")
}

enum ConnectorTestStatus {
  SUCCESS
  FAILURE
  TIMEOUT
  ERROR
}

enum CredentialType {
  API_KEY
  BASIC_AUTH
  OAUTH2
  BEARER_TOKEN
  CLIENT_CREDENTIALS
  CERTIFICATE
  SSH_KEY
  CUSTOM
}

enum CapabilityCategory {
  SYNC
  ASYNC
  WEBHOOK
  POLLING
  BATCH
  STREAM
  CRUD
  SEARCH
  REPORT
  CUSTOM
}

enum ConnectorEventType {
  REGISTERED
  CONFIGURED
  ENABLED
  DISABLED
  TESTED
  CONNECTION_SUCCESS
  CONNECTION_FAILURE
  CREDENTIAL_ROTATED
  CAPABILITY_ENABLED
  CAPABILITY_DISABLED
  ERROR
}

// ============================================
// Inventory & ATP Models
// ============================================

model Warehouse {
  id              String              @id @default(cuid())
  code            String
  name            String
  description     String?
  type            WarehouseType       @default(STANDARD)
  isActive        Boolean             @default(true)
  isDefault       Boolean             @default(false)

  // Location
  address         Json                @default("{}")
  latitude        Decimal?            @db.Decimal(10, 7)
  longitude       Decimal?            @db.Decimal(10, 7)
  timezone        String              @default("UTC")

  // Contact
  contactName     String?
  contactEmail    String?
  contactPhone    String?

  // Configuration
  safetyStockDays Int                 @default(3)
  leadTimeDays    Int                 @default(2)
  cutoffTime      String?             // e.g. "14:00" - orders after this go next day
  operatingDays   Int[]               @default([1, 2, 3, 4, 5]) // 1=Mon, 7=Sun

  // External system mapping
  externalId      String?
  externalSystem  String?

  metadata        Json                @default("{}")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  deletedAt       DateTime?

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  inventoryLevels InventoryLevel[]
  reservations    InventoryReservation[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@index([isDefault])
  @@index([externalId])
  @@map("warehouses")
}

model InventoryLevel {
  id              String              @id @default(cuid())
  sku             String

  // Quantities
  quantityOnHand  Int                 @default(0)
  quantityReserved Int                @default(0)
  quantityOnOrder Int                 @default(0)         // Incoming purchase orders
  quantityAllocated Int               @default(0)        // Allocated to specific orders

  // Calculated fields (updated on inventory changes)
  quantityAvailable Int               @default(0)        // On hand - reserved - allocated
  atp             Int                 @default(0)        // Available to Promise

  // Thresholds
  reorderPoint    Int?
  safetyStock     Int                 @default(0)
  minOrderQty     Int                 @default(1)
  maxOrderQty     Int?

  // Status
  availability    ProductAvailability @default(IN_STOCK)
  lastSyncAt      DateTime?
  lastSyncSource  String?

  // Tracking
  lastReceivedAt  DateTime?
  lastSoldAt      DateTime?
  averageDailySales Decimal?          @db.Decimal(15, 4)
  daysOfStock     Int?

  // External system mapping
  externalId      String?
  externalSystem  String?

  metadata        Json                @default("{}")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Foreign Keys
  tenantId        String
  warehouseId     String
  masterProductId String?

  // Relations
  tenant          Tenant              @relation(fields: [tenantId], references: [id])
  warehouse       Warehouse           @relation(fields: [warehouseId], references: [id])
  masterProduct   MasterProduct?      @relation(fields: [masterProductId], references: [id])
  reservations    InventoryReservation[]
  movements       InventoryMovement[]
  alerts          InventoryAlert[]

  @@unique([tenantId, warehouseId, sku])
  @@index([tenantId])
  @@index([warehouseId])
  @@index([sku])
  @@index([masterProductId])
  @@index([availability])
  @@index([atp])
  @@index([lastSyncAt])
  @@map("inventory_levels")
}

model InventoryReservation {
  id              String                      @id @default(cuid())
  reservationNumber String

  // Reservation details
  sku             String
  quantity        Int
  quantityFulfilled Int                       @default(0)
  status          InventoryReservationStatus  @default(PENDING)
  type            InventoryReservationType    @default(ORDER)

  // Priority and expiration
  priority        Int                         @default(0)
  expiresAt       DateTime
  releasedAt      DateTime?
  fulfilledAt     DateTime?

  // Reference to source
  sourceType      String                      // 'order', 'cart', 'quote', 'transfer'
  sourceId        String                      // orderId, cartId, etc.

  // External reference
  externalRef     String?

  notes           String?
  metadata        Json                        @default("{}")
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt

  // Foreign Keys
  tenantId        String
  warehouseId     String
  inventoryLevelId String
  userId          String?

  // Relations
  tenant          Tenant                      @relation(fields: [tenantId], references: [id])
  warehouse       Warehouse                   @relation(fields: [warehouseId], references: [id])
  inventoryLevel  InventoryLevel              @relation(fields: [inventoryLevelId], references: [id])
  user            User?                       @relation(fields: [userId], references: [id])

  @@unique([tenantId, reservationNumber])
  @@index([tenantId])
  @@index([warehouseId])
  @@index([inventoryLevelId])
  @@index([sku])
  @@index([status])
  @@index([sourceType, sourceId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("inventory_reservations")
}

model InventoryMovement {
  id              String                      @id @default(cuid())
  movementNumber  String
  type            InventoryMovementType

  // Quantities
  quantity        Int
  previousQty     Int
  newQty          Int

  // Reference
  referenceType   String?                     // 'order', 'purchase_order', 'adjustment', 'transfer'
  referenceId     String?

  // Cost tracking
  unitCost        Decimal?                    @db.Decimal(15, 4)
  totalCost       Decimal?                    @db.Decimal(15, 2)

  reason          String?
  notes           String?
  metadata        Json                        @default("{}")
  createdAt       DateTime                    @default(now())

  // Foreign Keys
  tenantId        String
  inventoryLevelId String
  userId          String?

  // Relations
  tenant          Tenant                      @relation(fields: [tenantId], references: [id])
  inventoryLevel  InventoryLevel              @relation(fields: [inventoryLevelId], references: [id])
  user            User?                       @relation(fields: [userId], references: [id])

  @@unique([tenantId, movementNumber])
  @@index([tenantId])
  @@index([inventoryLevelId])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdAt])
  @@map("inventory_movements")
}

model InventoryAlert {
  id              String                      @id @default(cuid())
  alertType       InventoryAlertType
  severity        AlertSeverity               @default(WARNING)
  status          AlertStatus                 @default(ACTIVE)

  // Alert details
  title           String
  message         String
  threshold       Int?
  currentValue    Int?

  // Resolution
  acknowledgedAt  DateTime?
  acknowledgedById String?
  resolvedAt      DateTime?
  resolvedById    String?

  metadata        Json                        @default("{}")
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt

  // Foreign Keys
  tenantId        String
  inventoryLevelId String

  // Relations
  tenant          Tenant                      @relation(fields: [tenantId], references: [id])
  inventoryLevel  InventoryLevel              @relation(fields: [inventoryLevelId], references: [id])

  @@index([tenantId])
  @@index([inventoryLevelId])
  @@index([alertType])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@map("inventory_alerts")
}

model InventorySyncJob {
  id              String                      @id @default(cuid())
  jobType         InventorySyncJobType
  status          SyncJobStatus               @default(PENDING)

  // Scope
  connectorId     String?
  warehouseId     String?

  // Progress
  totalItems      Int                         @default(0)
  processedItems  Int                         @default(0)
  successCount    Int                         @default(0)
  errorCount      Int                         @default(0)

  // Timing
  startedAt       DateTime?
  completedAt     DateTime?

  // Results
  errors          Json?
  summary         Json?

  metadata        Json                        @default("{}")
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant                      @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([jobType])
  @@index([status])
  @@index([createdAt])
  @@map("inventory_sync_jobs")
}

enum WarehouseType {
  STANDARD
  DISTRIBUTION_CENTER
  FULFILLMENT_CENTER
  DROP_SHIP
  VIRTUAL
}

enum InventoryReservationStatus {
  PENDING
  CONFIRMED
  PARTIALLY_FULFILLED
  FULFILLED
  RELEASED
  EXPIRED
  CANCELLED
}

enum InventoryReservationType {
  ORDER
  CART
  QUOTE
  TRANSFER
  HOLD
}

enum InventoryMovementType {
  RECEIPT
  SALE
  RETURN
  ADJUSTMENT_INCREASE
  ADJUSTMENT_DECREASE
  TRANSFER_IN
  TRANSFER_OUT
  RESERVATION
  RELEASE
  WRITE_OFF
  CYCLE_COUNT
}

enum InventoryAlertType {
  LOW_STOCK
  OUT_OF_STOCK
  OVERSTOCK
  REORDER_POINT
  SAFETY_STOCK_BREACH
  SYNC_FAILURE
  RESERVATION_EXPIRING
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
}

enum InventorySyncJobType {
  FULL_SYNC
  DELTA_SYNC
  WAREHOUSE_SYNC
  PRODUCT_SYNC
}

enum SyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// Price List Models
// ============================================

model PriceList {
  id              String            @id @default(cuid())
  code            String
  name            String
  description     String?
  type            PriceListType     @default(STANDARD)
  status          PriceListStatus   @default(ACTIVE)
  currency        String            @default("USD")
  priority        Int               @default(0)

  // Effective dates
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  // Price basis
  basePriceListId String?
  priceModifier   Decimal?          @db.Decimal(10, 4) // Multiplier for derived price lists
  roundingRule    RoundingRule      @default(NONE)
  roundingPrecision Int             @default(2)

  // Scope
  isDefault       Boolean           @default(false)
  isCustomerSpecific Boolean        @default(false)

  // External system mapping
  externalId      String?
  externalSystem  String?
  lastSyncAt      DateTime?
  syncStatus      SyncJobStatus?

  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  basePriceList   PriceList?        @relation("DerivedPriceLists", fields: [basePriceListId], references: [id])
  derivedPriceLists PriceList[]     @relation("DerivedPriceLists")
  items           PriceListItem[]
  customerAssignments CustomerPriceAssignment[]
  syncJobs        PriceListSyncJob[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([status])
  @@index([effectiveFrom, effectiveTo])
  @@index([currency])
  @@index([priority])
  @@index([isDefault])
  @@index([externalId])
  @@map("price_lists")
}

model PriceListItem {
  id              String            @id @default(cuid())
  sku             String

  // Pricing
  basePrice       Decimal           @db.Decimal(15, 4)
  listPrice       Decimal           @db.Decimal(15, 4)
  minPrice        Decimal?          @db.Decimal(15, 4) // Floor price
  maxPrice        Decimal?          @db.Decimal(15, 4) // Ceiling price
  cost            Decimal?          @db.Decimal(15, 4) // Cost for margin calculations

  // Currency (if different from price list default)
  currency        String?

  // Quantity breaks (volume pricing)
  quantityBreaks  Json              @default("[]")

  // Discount settings
  maxDiscountPercent Decimal?       @db.Decimal(5, 2)
  isDiscountable  Boolean           @default(true)

  // Effective dates (overrides price list dates)
  effectiveFrom   DateTime?
  effectiveTo     DateTime?

  // Status
  isActive        Boolean           @default(true)

  // Unit of measure
  uom             String            @default("EA")

  // External system mapping
  externalId      String?
  externalSystem  String?
  lastSyncAt      DateTime?

  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Foreign Keys
  priceListId     String
  masterProductId String?

  // Relations
  priceList       PriceList         @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  masterProduct   MasterProduct?    @relation(fields: [masterProductId], references: [id])
  overrides       PriceOverride[]

  @@unique([priceListId, sku])
  @@index([priceListId])
  @@index([sku])
  @@index([masterProductId])
  @@index([isActive])
  @@index([effectiveFrom, effectiveTo])
  @@map("price_list_items")
}

model CustomerPriceAssignment {
  id              String            @id @default(cuid())

  // Assignment type - can be customer, organization, or customer group
  assignmentType  PriceAssignmentType @default(CUSTOMER)
  assignmentId    String            // userId, organizationId, or customerGroupId

  // Priority for conflict resolution (higher = more priority)
  priority        Int               @default(0)

  // Effective dates
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  // Status
  isActive        Boolean           @default(true)

  // External reference
  externalRef     String?

  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Foreign Keys
  tenantId        String
  priceListId     String

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  priceList       PriceList         @relation(fields: [priceListId], references: [id], onDelete: Cascade)

  @@unique([tenantId, priceListId, assignmentType, assignmentId])
  @@index([tenantId])
  @@index([priceListId])
  @@index([assignmentType, assignmentId])
  @@index([effectiveFrom, effectiveTo])
  @@index([isActive])
  @@map("customer_price_assignments")
}

model PriceOverride {
  id              String            @id @default(cuid())

  // Override type
  overrideType    PriceOverrideType @default(FIXED_PRICE)

  // Override value (interpretation depends on type)
  overrideValue   Decimal           @db.Decimal(15, 4)

  // Scope - who gets this override
  scopeType       PriceOverrideScopeType @default(CUSTOMER)
  scopeId         String            // userId, organizationId, contractId, etc.

  // Effective dates
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  // Quantity conditions
  minQuantity     Int?
  maxQuantity     Int?

  // Approval tracking
  status          PriceOverrideStatus @default(ACTIVE)
  approvedById    String?
  approvedAt      DateTime?
  reason          String?

  // External reference
  externalRef     String?

  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Foreign Keys
  tenantId        String
  priceListItemId String

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  priceListItem   PriceListItem     @relation(fields: [priceListItemId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([priceListItemId])
  @@index([scopeType, scopeId])
  @@index([effectiveFrom, effectiveTo])
  @@index([status])
  @@map("price_overrides")
}

model CurrencyExchangeRate {
  id              String            @id @default(cuid())
  sourceCurrency  String
  targetCurrency  String
  rate            Decimal           @db.Decimal(18, 8)

  // Effective dates
  effectiveFrom   DateTime
  effectiveTo     DateTime?

  // Source of rate
  rateSource      String?           // e.g., 'ECB', 'manual', 'API'

  // Type of rate
  rateType        ExchangeRateType  @default(SPOT)

  isActive        Boolean           @default(true)

  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Foreign Keys
  tenantId        String

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, sourceCurrency, targetCurrency, effectiveFrom, rateType])
  @@index([tenantId])
  @@index([sourceCurrency, targetCurrency])
  @@index([effectiveFrom, effectiveTo])
  @@index([isActive])
  @@map("currency_exchange_rates")
}

model PriceListSyncJob {
  id              String            @id @default(cuid())
  jobType         PriceListSyncJobType
  status          SyncJobStatus     @default(PENDING)

  // Scope
  connectorId     String?

  // Progress
  totalItems      Int               @default(0)
  processedItems  Int               @default(0)
  successCount    Int               @default(0)
  errorCount      Int               @default(0)
  skippedCount    Int               @default(0)

  // Delta sync tracking
  lastSyncedAt    DateTime?
  deltaToken      String?

  // Timing
  startedAt       DateTime?
  completedAt     DateTime?

  // Results
  errors          Json?
  summary         Json?

  metadata        Json              @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Foreign Keys
  tenantId        String
  priceListId     String

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id])
  priceList       PriceList         @relation(fields: [priceListId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([priceListId])
  @@index([jobType])
  @@index([status])
  @@index([createdAt])
  @@map("price_list_sync_jobs")
}

enum PriceListType {
  STANDARD
  CONTRACT
  PROMOTIONAL
  VOLUME
  CUSTOMER_SPECIFIC
  CHANNEL
  REGIONAL
}

enum PriceListStatus {
  DRAFT
  ACTIVE
  INACTIVE
  EXPIRED
  ARCHIVED
}

enum RoundingRule {
  NONE
  UP
  DOWN
  NEAREST
  NEAREST_05
  NEAREST_09
  NEAREST_99
}

enum PriceAssignmentType {
  CUSTOMER
  ORGANIZATION
  CUSTOMER_GROUP
  CHANNEL
  REGION
}

enum PriceOverrideType {
  FIXED_PRICE
  PERCENTAGE_DISCOUNT
  FIXED_DISCOUNT
  MARKUP_PERCENTAGE
  MARKUP_FIXED
}

enum PriceOverrideScopeType {
  CUSTOMER
  ORGANIZATION
  CONTRACT
  QUOTE
  ORDER
  PROMOTION
}

enum PriceOverrideStatus {
  PENDING_APPROVAL
  ACTIVE
  EXPIRED
  REVOKED
}

enum ExchangeRateType {
  SPOT
  FORWARD
  AVERAGE
  BUDGETED
}

enum PriceListSyncJobType {
  FULL_SYNC
  DELTA_SYNC
  PRICE_LIST_IMPORT
  PRICE_UPDATE
}
